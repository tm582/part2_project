---
title: "TCGA_mRNA_script"
author: "Tara Morrison"
date: "05/11/2018"
output: word_document
---
##Initial set up
Working Directory (Lab) & Libraries
``` {r}
setwd("~/Desktop/part2_project/Liver_Cancer/TCGA_Counts_mRNA_genelevel")

library(RColorBrewer)
library(gplots)
library(DESeq2)
```

##Upload pdata
Need to find gene names table
```{r}
pdata=read.table('pdata_rnaseq_genelevel_small.txt', header=T)
rownames(pdata)=pdata$Sample
```

##Set Conditions/Sample Types
There are 3 levels: Primary Tumour, Recurrent Tumour and Normal Tissue
```{r}
conds=(pdata$Sample_Type)
cond_colours=brewer.pal(length(unique(conds)), 'Set1')
names(cond_colours)=unique(conds)
```

##Read in count data
Data taken from TCGA data repository - Liver Cancer mRNA
datatype=HTSeq count data
```{r}
ddsHTSeq=DESeqDataSetFromHTSeqCount(sampleTable = pdata, directory= '.', design = ~ Sample_Type)

colData(ddsHTSeq)$Sample_Type=factor(colData(ddsHTSeq)$Sample_Type, levels=levels(pdata$Sample_Type))

dds=estimateSizeFactors(ddsHTSeq)
dds=estimateDispersions(dds)
```

##Data Normalisation

```{r}
normcounts <- counts(dds, normalized=TRUE)
rawcounts=counts(dds,normalized=FALSE)
log2counts=log2(normcounts+1)
```


##Quality Control
```{r echo = FALSE}
quartz()
par(mfrow=c(1,2))
barplot(colSums(counts(dds, normalized=FALSE)), col=cond_colours[pdata$Sample_Type], las=2,cex.names=0.5,main='Pre Normalised Counts')
legend("topleft",levels((conds)),cex=0.5,fill=cond_colours[levels((conds))])
barplot(colSums(counts(dds, normalized=TRUE)), col=cond_colours[pdata$Sample_Type], las=2,cex.names=0.5,main='Post Normalised Counts')
legend('topleft',levels((conds)),cex=0.5,fill=cond_colours[levels((conds))])
```

##Dispersion Plot
```{r echo = FALSE}
dds=nbinomWaldTest(dds)
counts_table=counts(dds, normalized=TRUE)
quartz()
plotDispEsts(dds,main='Dispersion Plot')
```

##Variance Stabilising Transformation
```{r}
vsd <- varianceStabilizingTransformation(dds)
vstMat <- assay(vsd)
vstcounts <- vstMat[order(apply(vstMat,1,sum),decreasing =TRUE),]
```

#PCA Plots & Heatmaps
```{r echo = FALSE}
pca=princomp(assay(vsd))
quartz()
plot(pca$loadings, main='PCA Variance Stabilised', pch=21, col='black', bg=cond_colours[pdata$Sample_Type],cex=1)
text(pca$loadings, as.character(conds), pos=1, cex=0.4)

hmcol = colorRampPalette(brewer.pal(9, 'GnBu'))(100)
heatmap.2(cor(vstcounts),trace="none",labRow = pdata$Sample_Type, cexRow = 0.6, labCol = pdata$Sample_Type, cexCol = 0.6)
```

#Statistical Analysis
P threshold is set to 0.05.
log fold change threshold set to 0.7
```{r}
p_threshold=0.05
lfc_threshold=0.7

condition_list=levels(conds)

for (i in 1:length(condition_list)){
 
  normal=condition_list[3]
  compare=condition_list[i]

  print(paste('Comparing', normal, 'vs.', compare))
  
  res=results(dds, contrast = c('Sample_Type', normal, compare))
  res=res[order(res$padj)]
  
}
```
Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
